<div class="checkout-page">
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">Checkout</h1>
      <div class="breadcrumb-nav">
        <a routerLink="/home">Home</a>
        <mat-icon>chevron_right</mat-icon>
        <a routerLink="/cart">Cart</a>
        <mat-icon>chevron_right</mat-icon>
        <span class="current">Checkout</span>
      </div>
    </div>

    <div class="checkout-progress">
      <mat-horizontal-stepper [linear]="true" #stepper class="neumorph-stepper">
        <mat-step [stepControl]="shippingForm" label="Shipping">
          <div class="step-container">
            <h2 class="step-title">Shipping Information</h2>

            <form [formGroup]="shippingForm" class="checkout-form">
              <div class="form-section personal-info">
                <h3 class="section-title">Contact Information</h3>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="neumorph-input">
                    <mat-label>Email</mat-label>
                    <input
                      matInput
                      formControlName="email"
                      type="email"
                      placeholder="your.email@example.com"
                    />
                    <mat-error
                      *ngIf="shippingForm.get('email')?.hasError('required')"
                      >Email is required</mat-error
                    >
                    <mat-error
                      *ngIf="shippingForm.get('email')?.hasError('email')"
                      >Please enter a valid email address</mat-error
                    >
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="neumorph-input">
                    <mat-label>Phone Number</mat-label>
                    <input
                      matInput
                      formControlName="phone"
                      type="tel"
                      placeholder="(123) 456-7890"
                    />
                    <mat-error
                      *ngIf="shippingForm.get('phone')?.hasError('required')"
                      >Phone number is required</mat-error
                    >
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="neumorph-input">
                    <mat-label>First Name</mat-label>
                    <input
                      matInput
                      formControlName="firstName"
                      placeholder="John"
                    />
                    <mat-error
                      *ngIf="
                        shippingForm.get('firstName')?.hasError('required')
                      "
                      >First name is required</mat-error
                    >
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="neumorph-input">
                    <mat-label>Last Name</mat-label>
                    <input
                      matInput
                      formControlName="lastName"
                      placeholder="Doe"
                    />
                    <mat-error
                      *ngIf="shippingForm.get('lastName')?.hasError('required')"
                      >Last name is required</mat-error
                    >
                  </mat-form-field>
                </div>
              </div>

              <div class="form-section address-info">
                <h3 class="section-title">Shipping Address</h3>

                <div class="form-row">
                  <mat-form-field
                    appearance="outline"
                    class="neumorph-input full-width"
                  >
                    <mat-label>Address Line 1</mat-label>
                    <input
                      matInput
                      formControlName="address1"
                      placeholder="123 Main St"
                    />
                    <mat-error
                      *ngIf="shippingForm.get('address1')?.hasError('required')"
                      >Address is required</mat-error
                    >
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field
                    appearance="outline"
                    class="neumorph-input full-width"
                  >
                    <mat-label>Address Line 2</mat-label>
                    <input
                      matInput
                      formControlName="address2"
                      placeholder="Apt, Suite, Unit, etc. (optional)"
                    />
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="neumorph-input">
                    <mat-label>City</mat-label>
                    <input
                      matInput
                      formControlName="city"
                      placeholder="New York"
                    />
                    <mat-error
                      *ngIf="shippingForm.get('city')?.hasError('required')"
                      >City is required</mat-error
                    >
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="neumorph-input">
                    <mat-label>State</mat-label>
                    <mat-select formControlName="state">
                      <mat-option
                        *ngFor="let state of states"
                        [value]="state.value"
                      >
                        {{ state.name }}
                      </mat-option>
                    </mat-select>
                    <mat-error
                      *ngIf="shippingForm.get('state')?.hasError('required')"
                      >State is required</mat-error
                    >
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="neumorph-input">
                    <mat-label>ZIP Code</mat-label>
                    <input
                      matInput
                      formControlName="zipCode"
                      placeholder="10001"
                    />
                    <mat-error
                      *ngIf="shippingForm.get('zipCode')?.hasError('required')"
                      >ZIP code is required</mat-error
                    >
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="neumorph-input">
                    <mat-label>Country</mat-label>
                    <mat-select formControlName="country">
                      <mat-option value="US">United States</mat-option>
                      <mat-option value="CA">Canada</mat-option>
                      <mat-option value="MX">Mexico</mat-option>
                    </mat-select>
                    <mat-error
                      *ngIf="shippingForm.get('country')?.hasError('required')"
                      >Country is required</mat-error
                    >
                  </mat-form-field>
                </div>
              </div>

              <div class="form-section shipping-options">
                <h3 class="section-title">Shipping Method</h3>

                <mat-radio-group
                  formControlName="shippingMethod"
                  class="shipping-methods"
                >
                  <mat-radio-button
                    value="standard"
                    class="shipping-option neumorph-radio"
                  >
                    <div class="option-content">
                      <div class="option-info">
                        <h4>Standard Shipping</h4>
                        <p>Delivery in 5-7 business days</p>
                      </div>
                      <div class="option-price">
                        <span *ngIf="standardShippingCost > 0"
                          >${{ standardShippingCost.toFixed(2) }}</span
                        >
                        <span
                          *ngIf="standardShippingCost === 0"
                          class="free-shipping"
                          >Free</span
                        >
                      </div>
                    </div>
                  </mat-radio-button>

                  <mat-radio-button
                    value="express"
                    class="shipping-option neumorph-radio"
                  >
                    <div class="option-content">
                      <div class="option-info">
                        <h4>Express Shipping</h4>
                        <p>Delivery in 2-3 business days</p>
                      </div>
                      <div class="option-price">
                        ${{ expressShippingCost.toFixed(2) }}
                      </div>
                    </div>
                  </mat-radio-button>

                  <mat-radio-button
                    value="overnight"
                    class="shipping-option neumorph-radio"
                  >
                    <div class="option-content">
                      <div class="option-info">
                        <h4>Overnight Shipping</h4>
                        <p>Delivery next business day</p>
                      </div>
                      <div class="option-price">
                        ${{ overnightShippingCost.toFixed(2) }}
                      </div>
                    </div>
                  </mat-radio-button>
                </mat-radio-group>
              </div>

              <div class="form-actions">
                <button
                  mat-stroked-button
                  routerLink="/cart"
                  class="neumorph-button back-btn"
                >
                  <mat-icon>arrow_back</mat-icon>
                  Back to Cart
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  class="neumorph-button next-btn"
                  [disabled]="shippingForm.invalid"
                  (click)="nextStep()"
                >
                  Continue to Payment
                  <mat-icon>arrow_forward</mat-icon>
                </button>
              </div>
            </form>
          </div>
        </mat-step>

        <mat-step [stepControl]="paymentForm" label="Payment">
          <div class="step-container">
            <h2 class="step-title">Payment Information</h2>

            <form [formGroup]="paymentForm" class="checkout-form">
              <div class="form-section payment-options">
                <h3 class="section-title">Payment Method</h3>

                <mat-tab-group
                  formControlName="paymentType"
                  class="payment-tabs neumorph-tabs"
                >
                  <mat-tab label="Credit Card">
                    <div class="payment-tab-content credit-card-form">
                      <div class="form-row">
                        <mat-form-field
                          appearance="outline"
                          class="neumorph-input full-width"
                        >
                          <mat-label>Card Number</mat-label>
                          <input
                            matInput
                            formControlName="cardNumber"
                            placeholder="1234 5678 9012 3456"
                          />
                          <mat-icon matPrefix>credit_card</mat-icon>
                          <mat-error
                            *ngIf="
                              paymentForm
                                .get('cardNumber')
                                ?.hasError('required')
                            "
                            >Card number is required</mat-error
                          >
                        </mat-form-field>
                      </div>

                      <div class="form-row">
                        <mat-form-field
                          appearance="outline"
                          class="neumorph-input"
                        >
                          <mat-label>Cardholder Name</mat-label>
                          <input
                            matInput
                            formControlName="cardholderName"
                            placeholder="John Doe"
                          />
                          <mat-error
                            *ngIf="
                              paymentForm
                                .get('cardholderName')
                                ?.hasError('required')
                            "
                            >Cardholder name is required</mat-error
                          >
                        </mat-form-field>
                      </div>

                      <div class="form-row">
                        <mat-form-field
                          appearance="outline"
                          class="neumorph-input"
                        >
                          <mat-label>Expiration Date</mat-label>
                          <input
                            matInput
                            formControlName="expirationDate"
                            placeholder="MM/YY"
                          />
                          <mat-error
                            *ngIf="
                              paymentForm
                                .get('expirationDate')
                                ?.hasError('required')
                            "
                            >Expiration date is required</mat-error
                          >
                        </mat-form-field>

                        <mat-form-field
                          appearance="outline"
                          class="neumorph-input"
                          style="max-width: 120px"
                        >
                          <mat-label>CVV</mat-label>
                          <input
                            matInput
                            formControlName="cvv"
                            placeholder="123"
                            type="password"
                          />
                          <mat-icon
                            matSuffix
                            matTooltip="3-digit code on the back of your card"
                            >help_outline</mat-icon
                          >
                          <mat-error
                            *ngIf="paymentForm.get('cvv')?.hasError('required')"
                            >CVV is required</mat-error
                          >
                        </mat-form-field>
                      </div>
                    </div>
                  </mat-tab>

                  <mat-tab label="PayPal">
                    <div class="payment-tab-content paypal-content">
                      <div class="paypal-info">
                        <img
                          src="/api/placeholder/100/40"
                          alt="PayPal logo"
                          class="paypal-logo"
                        />
                        <p>
                          After clicking "Complete Order", you will be
                          redirected to PayPal to complete your purchase
                          securely.
                        </p>
                      </div>
                    </div>
                  </mat-tab>
                </mat-tab-group>
              </div>

              <div class="form-section billing-address">
                <div class="use-shipping">
                  <mat-checkbox
                    formControlName="sameAsShipping"
                    (change)="onSameAsShippingChange()"
                  >
                    Billing address same as shipping address
                  </mat-checkbox>
                </div>

                <div
                  *ngIf="!paymentForm.get('sameAsShipping')?.value"
                  class="billing-form"
                >
                  <!-- Billing address form fields here -->
                  <div class="form-row">
                    <mat-form-field
                      appearance="outline"
                      class="neumorph-input full-width"
                    >
                      <mat-label>Billing Address</mat-label>
                      <input
                        matInput
                        formControlName="billingAddress"
                        placeholder="123 Main St"
                      />
                      <mat-error
                        *ngIf="
                          paymentForm
                            .get('billingAddress')
                            ?.hasError('required')
                        "
                        >Billing address is required</mat-error
                      >
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="neumorph-input">
                      <mat-label>City</mat-label>
                      <input
                        matInput
                        formControlName="billingCity"
                        placeholder="New York"
                      />
                      <mat-error
                        *ngIf="
                          paymentForm.get('billingCity')?.hasError('required')
                        "
                        >City is required</mat-error
                      >
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="neumorph-input">
                      <mat-label>State</mat-label>
                      <mat-select formControlName="billingState">
                        <mat-option
                          *ngFor="let state of states"
                          [value]="state.value"
                        >
                          {{ state.name }}
                        </mat-option>
                      </mat-select>
                      <mat-error
                        *ngIf="
                          paymentForm.get('billingState')?.hasError('required')
                        "
                        >State is required</mat-error
                      >
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="neumorph-input">
                      <mat-label>ZIP Code</mat-label>
                      <input
                        matInput
                        formControlName="billingZipCode"
                        placeholder="10001"
                      />
                      <mat-error
                        *ngIf="
                          paymentForm
                            .get('billingZipCode')
                            ?.hasError('required')
                        "
                        >ZIP code is required</mat-error
                      >
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="neumorph-input">
                      <mat-label>Country</mat-label>
                      <mat-select formControlName="billingCountry">
                        <mat-option value="US">United States</mat-option>
                        <mat-option value="CA">Canada</mat-option>
                        <mat-option value="MX">Mexico</mat-option>
                      </mat-select>
                      <mat-error
                        *ngIf="
                          paymentForm
                            .get('billingCountry')
                            ?.hasError('required')
                        "
                        >Country is required</mat-error
                      >
                    </mat-form-field>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button
                  mat-stroked-button
                  class="neumorph-button back-btn"
                  (click)="prevStep()"
                >
                  <mat-icon>arrow_back</mat-icon>
                  Back to Shipping
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  class="neumorph-button next-btn"
                  [disabled]="paymentForm.invalid"
                  (click)="nextStep()"
                >
                  Review Order
                  <mat-icon>arrow_forward</mat-icon>
                </button>
              </div>
            </form>
          </div>
        </mat-step>

        <mat-step label="Review">
          <div class="step-container">
            <h2 class="step-title">Review Your Order</h2>

            <div class="review-sections">
              <div class="review-section neumorph-card">
                <div class="section-header">
                  <h3>Items In Your Order</h3>
                  <a routerLink="/cart" class="edit-link">Edit</a>
                </div>

                <div class="order-items">
                  <div *ngFor="let item of cartItems" class="order-item">
                    <div class="item-image">
                      <img
                        [src]="
                          item.product.imageUrl || '/api/placeholder/80/80'
                        "
                        [alt]="item.product.name"
                      />
                    </div>

                    <div class="item-details">
                      <h4 class="item-title">{{ item.product.name }}</h4>
                      <div
                        class="item-options"
                        *ngIf="item.options && item.options.length > 0"
                      >
                        <span
                          *ngFor="let option of item.options"
                          class="item-option"
                        >
                          {{ option.name }}: <strong>{{ option.value }}</strong>
                        </span>
                      </div>
                      <div class="item-quantity">Qty: {{ item.quantity }}</div>
                    </div>

                    <div class="item-price">
                      ${{ (item.product.price * item.quantity).toFixed(2) }}
                    </div>
                  </div>
                </div>
              </div>

              <div class="review-section neumorph-card">
                <div class="section-header">
                  <h3>Shipping Information</h3>
                  <button mat-button class="edit-link" (click)="editStep(0)">
                    Edit
                  </button>
                </div>

                <div class="shipping-details">
                  <div class="shipping-address">
                    <h4>Shipping Address</h4>
                    <p>
                      {{ shippingForm.get("firstName")?.value }}
                      {{ shippingForm.get("lastName")?.value }}
                    </p>
                    <p>{{ shippingForm.get("address1")?.value }}</p>
                    <p *ngIf="shippingForm.get('address2')?.value">
                      {{ shippingForm.get("address2")?.value }}
                    </p>
                    <p>
                      {{ shippingForm.get("city")?.value }},
                      {{ getStateName(shippingForm.get("state")?.value) }}
                      {{ shippingForm.get("zipCode")?.value }}
                    </p>
                    <p>
                      {{ getCountryName(shippingForm.get("country")?.value) }}
                    </p>
                    <p>{{ shippingForm.get("phone")?.value }}</p>
                    <p>{{ shippingForm.get("email")?.value }}</p>
                  </div>

                  <div class="shipping-method">
                    <h4>Shipping Method</h4>
                    <p>
                      <ng-container
                        [ngSwitch]="shippingForm.get('shippingMethod')?.value"
                      >
                        <ng-container *ngSwitchCase="'standard'">
                          Standard Shipping (5-7 business days)
                          <span *ngIf="standardShippingCost > 0"
                            >${{ standardShippingCost.toFixed(2) }}</span
                          >
                          <span
                            *ngIf="standardShippingCost === 0"
                            class="free-shipping"
                            >Free</span
                          >
                        </ng-container>
                        <ng-container *ngSwitchCase="'express'">
                          Express Shipping (2-3 business days)
                          <span>${{ expressShippingCost.toFixed(2) }}</span>
                        </ng-container>
                        <ng-container *ngSwitchCase="'overnight'">
                          Overnight Shipping (Next business day)
                          <span>${{ overnightShippingCost.toFixed(2) }}</span>
                        </ng-container>
                      </ng-container>
                    </p>
                  </div>
                </div>
              </div>

              <div class="review-section neumorph-card">
                <div class="section-header">
                  <h3>Payment Information</h3>
                  <button mat-button class="edit-link" (click)="editStep(1)">
                    Edit
                  </button>
                </div>

                <div class="payment-details">
                  <div class="payment-method">
                    <h4>Payment Method</h4>
                    <p>
                      <ng-container
                        [ngSwitch]="paymentForm.get('paymentType')?.value"
                      >
                        <ng-container *ngSwitchCase="0">
                          Credit Card: **** **** ****
                          {{ paymentForm.get("cardNumber")?.value?.slice(-4) }}
                        </ng-container>
                        <ng-container *ngSwitchCase="1"> PayPal </ng-container>
                      </ng-container>
                    </p>
                  </div>

                  <div
                    class="billing-address"
                    *ngIf="!paymentForm.get('sameAsShipping')?.value"
                  >
                    <h4>Billing Address</h4>
                    <p>{{ paymentForm.get("cardholderName")?.value }}</p>
                    <p>{{ paymentForm.get("billingAddress")?.value }}</p>
                    <p>
                      {{ paymentForm.get("billingCity")?.value }},
                      {{
                        getStateName(paymentForm.get("billingState")?.value)
                      }}
                      {{ paymentForm.get("billingZipCode")?.value }}
                    </p>
                    <p>
                      {{
                        getCountryName(paymentForm.get("billingCountry")?.value)
                      }}
                    </p>
                  </div>

                  <div
                    class="billing-address"
                    *ngIf="paymentForm.get('sameAsShipping')?.value"
                  >
                    <h4>Billing Address</h4>
                    <p>Same as shipping address</p>
                  </div>
                </div>
              </div>

              <div class="review-section neumorph-card order-summary">
                <h3>Order Summary</h3>

                <div class="summary-items">
                  <div class="summary-row">
                    <span>Subtotal</span>
                    <span>${{ calculateSubtotal().toFixed(2) }}</span>
                  </div>

                  <div class="summary-row" *ngIf="discount > 0">
                    <span>Discount</span>
                    <span class="discount-value"
                      >-${{ discount.toFixed(2) }}</span
                    >
                  </div>

                  <div class="summary-row">
                    <span>Shipping</span>
                    <span *ngIf="getShippingCost() > 0"
                      >${{ getShippingCost().toFixed(2) }}</span
                    >
                    <span *ngIf="getShippingCost() === 0" class="free-shipping"
                      >Free</span
                    >
                  </div>

                  <div class="summary-row">
                    <span>Estimated Tax</span>
                    <span>${{ calculateTax().toFixed(2) }}</span>
                  </div>

                  <mat-divider></mat-divider>

                  <div class="summary-row total">
                    <span>Total</span>
                    <span>${{ calculateTotal().toFixed(2) }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="terms-agreement">
              <mat-checkbox [(ngModel)]="termsAgreed">
                I agree to the
                <a href="#" (click)="openTerms($event)">Terms & Conditions</a>
                and <a href="#" (click)="openPrivacy($event)">Privacy Policy</a>
              </mat-checkbox>
            </div>

            <div class="form-actions">
              <button
                mat-stroked-button
                class="neumorph-button back-btn"
                (click)="prevStep()"
              >
                <mat-icon>arrow_back</mat-icon>
                Back to Payment
              </button>
              <button
                mat-raised-button
                color="primary"
                class="neumorph-button complete-btn"
                [disabled]="!termsAgreed || isSubmitting"
                (click)="completeOrder()"
              >
                <mat-spinner
                  *ngIf="isSubmitting"
                  diameter="20"
                  class="spinner"
                ></mat-spinner>
                <span *ngIf="!isSubmitting">
                  Complete Order
                  <mat-icon>check_circle</mat-icon>
                </span>
              </button>
            </div>
          </div>
        </mat-step>

        <mat-step>
          <ng-template matStepLabel>Confirmation</ng-template>
          <div class="confirmation-container">
            <div class="confirmation-content neumorph-card">
              <div class="success-icon">
                <mat-icon>check_circle</mat-icon>
              </div>
              <h2>Order Confirmed!</h2>
              <p class="confirmation-message">
                Thank you for your order. We've received your payment and are
                preparing your items for shipment.
              </p>

              <div class="order-info">
                <div class="info-item">
                  <span class="info-label">Order Number:</span>
                  <span class="info-value">{{ orderNumber }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Order Date:</span>
                  <span class="info-value">{{
                    orderDate | date: "longDate"
                  }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Estimated Delivery:</span>
                  <span class="info-value">{{
                    estimatedDelivery | date: "longDate"
                  }}</span>
                </div>
              </div>

              <p class="email-confirmation">
                A confirmation email has been sent to
                <strong>{{ shippingForm.get("email")?.value }}</strong> with all
                the details of your order.
              </p>

              <div class="confirmation-actions">
                <a
                  routerLink="/orders"
                  mat-raised-button
                  class="neumorph-button track-btn"
                >
                  <mat-icon>local_shipping</mat-icon>
                  Track Your Order
                </a>
                <a
                  routerLink="/products"
                  mat-stroked-button
                  class="neumorph-button continue-btn"
                >
                  Continue Shopping
                </a>
              </div>
            </div>
          </div>
        </mat-step>
      </mat-horizontal-stepper>
    </div>
  </div>
</div>
